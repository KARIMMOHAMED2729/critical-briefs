<h2 class="text-2xl font-bold mb-4 pt-40 text-center dark:text-gray-200">طلباتي</h2>

<div *ngIf="loading" class="text-center text-gray-500 dark:text-gray-400">جارٍ تحميل الطلبات...</div>
<div *ngIf="error" class="text-center text-red-500 dark:text-red-400">{{ error }}</div>

<!-- جدول للـ md وأكبر -->
<div *ngIf="orders.length > 0" class="hidden md:block overflow-x-auto px-5">
  <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg shadow-md text-sm mx-auto">
    <thead>
      <tr class="bg-blue-100 dark:bg-[#0a1325] text-blue-700 dark:text-blue-300 uppercase text-xs font-semibold">
        <th class="py-3 px-4 text-center border-b border-blue-200 dark:border-blue-700">الكتب</th>
        <th class="py-3 px-4 text-center border-b border-blue-200 dark:border-blue-700">الكمية</th>
        <th class="py-3 px-4 text-center border-b border-blue-200 dark:border-blue-700">الحالة</th>
        <th class="py-3 px-4 text-center border-b border-blue-200 dark:border-blue-700">تاريخ الوصول المتوقع</th>
        <th class="py-3 px-4 text-center border-b border-blue-200 dark:border-blue-700">السعر الاجمالي</th>
        <th class="py-3 px-4 text-center border-b border-blue-200 dark:border-blue-700">إجراءات</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let order of orders; let orderIndex = index">
        <tr *ngFor="let product of order.products; let i = index" [ngClass]="{'bg-blue-50 dark:bg-[#0a1325]': orderIndex % 2 === 0, 'bg-white dark:bg-gray-900': orderIndex % 2 !== 0}">
          <td class="py-2 px-3 text-center border-b border-blue-200 dark:border-blue-700">
            {{ product.book }}
            <div *ngIf="order.status === 'تم التسليم'" class="mt-1">
              <label for="rating-{{order._id}}-{{i}}" class="text-xs mr-1 dark:text-gray-300">تقييم:</label>
              <select id="rating-{{order._id}}-{{i}}" [(ngModel)]="product.selectedRating" class="dark:bg-gray-700 dark:text-gray-200">
                <option value="0" disabled>اختر التقييم</option>
                <option [value]="1">لم يعجبني</option>
                <option [value]="2">لم يعجبني قليلاً</option>
                <option [value]="3">متوسط</option>
                <option [value]="4">أعجبني قليلاً</option>
                <option [value]="5">أعجبني بشدة</option>
              </select>
              <button (click)="submitRating(product.bookId || '', product.selectedRating ?? 0)" [disabled]="!product.selectedRating || product.selectedRating < 1 || product.selectedRating > 5" class="ml-2 bg-blue-500 dark:bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 dark:hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                إرسال التقييم
              </button>
            </div>
          </td>
          <td class="py-2 px-3 text-center border-b border-blue-200 dark:border-blue-700">{{ product.quantity }}</td>
          <td class="py-2 px-3 text-center border-b border-blue-200 dark:border-blue-700" *ngIf="i === 0" [attr.rowspan]="order.products.length">
            <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold" [ngClass]="{
              'bg-orange-500 text-white dark:bg-orange-600': order.status === 'قيد الإنتظار',
              'bg-yellow-800 text-yellow-200 dark:bg-yellow-700 dark:text-yellow-300': order.status === 'تم الشحن',
              'bg-green-500 text-green-200 dark:bg-green-600 dark:text-green-300': order.status === 'تم التسليم',
              'bg-red-500 text-red-200 dark:bg-red-600 dark:text-red-300': order.status === 'تم الإلغاء'
            }">{{ order.status }}</span>
          </td>
          <td class="py-2 px-3 text-center border-b border-blue-200 dark:border-blue-700" *ngIf="i === 0" [attr.rowspan]="order.products.length">
            {{ calculateExpectedDeliveryDate(order.orderDate) }}
          </td>
          <td class="py-2 px-3 text-center border-b border-blue-200 rtl dark:border-blue-700" *ngIf="i === 0" [attr.rowspan]="order.products.length">
            {{ order.totalAmount + ' ج.م' }}
          </td>
<td class="py-2 px-3 text-center border-b border-blue-200 dark:border-blue-700" *ngIf="i === 0" [attr.rowspan]="order.products.length">
  <div class="flex space-x-2 justify-center" *ngIf="i === 0" [attr.rowspan]="order.products.length">
    <button *ngIf="order.status === 'قيد الإنتظار'" (click)="cancelOrder(order._id)" class="bg-red-500 dark:bg-red-600 text-white py-2 px-4 rounded hover:bg-red-600 dark:hover:bg-red-700">
      إلغاء الطلب
    </button>
    <button *ngIf="order.status === 'قيد الإنتظار' || order.status === 'تم الشحن'" (click)="resumePayment(order)" class="bg-green-600 dark:bg-green-700 text-white py-2 px-4 rounded hover:bg-green-700 dark:hover:bg-green-800">
      استكمال الدفع
    </button>
  </div>
</td>
</tr>
      <!-- Display print projects for each order -->
      <ng-container *ngIf="order.printProjects && order.printProjects.length > 0">
        <ng-container *ngFor="let printProject of order.printProjects">
          <tr [ngClass]="{'bg-blue-50 dark:bg-[#0a1325]': orderIndex % 2 === 0, 'bg-white dark:bg-gray-900': orderIndex % 2 !== 0}">
            <td class="py-2 px-3 text-center border-b border-blue-200 dark:border-blue-700">
              <a [href]="printProject.filepath" target="_blank" class="text-blue-600 dark:text-blue-400 underline">
                {{ printProject.projectTitle }} - {{ printProject.filename }}
              </a>
              <div class="text-xs mt-1 dark:text-gray-300">
                الحجم: {{ printProject.size }} | الغلاف: {{ printProject.coverType }} | اللون: {{ printProject.printColor }} | الصفحات: {{ printProject.pages }} | النسخ: {{ printProject.copies }}
              </div>
              <div *ngIf="printProject.notes" class="text-xs mt-1 italic dark:text-gray-400">
                ملاحظات: {{ printProject.notes }}
              </div>
            </td>
            <td class="py-2 px-3 text-center border-b border-blue-200 dark:border-blue-700">{{ printProject.copies }}</td>
            <td class="py-2 px-3 text-center border-b border-blue-200 dark:border-blue-700" *ngIf="printProject === order.printProjects[0]" [attr.rowspan]="order.printProjects.length">
              <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold" [ngClass]="{
                'bg-orange-500 text-white dark:bg-orange-600': order.status === 'قيد الإنتظار',
                'bg-yellow-800 text-yellow-200 dark:bg-yellow-700 dark:text-yellow-300': order.status === 'تم الشحن',
                'bg-green-500 text-green-200 dark:bg-green-600 dark:text-green-300': order.status === 'تم التسليم',
                'bg-red-500 text-red-200 dark:bg-red-600 dark:text-red-300': order.status === 'تم الإلغاء'
              }">{{ order.status }}</span>
            </td>
            <td class="py-2 px-3 text-center border-b border-blue-200 dark:border-blue-700" *ngIf="printProject === order.printProjects[0]" [attr.rowspan]="order.printProjects.length">
              {{ calculatePrintProjectExpectedDeliveryDate(printProject.createdAt) }}
            </td>
            <td class="py-2 px-3 text-center border-b border-blue-200 rtl dark:border-blue-700" *ngIf="printProject === order.printProjects[0]" [attr.rowspan]="order.printProjects.length">
              {{ order.totalAmount + ' ج.م' }}
            </td>
            <td class="py-2 px-3 text-center border-b border-blue-200 dark:border-blue-700" *ngIf="printProject === order.printProjects[0]" [attr.rowspan]="order.printProjects.length">
              <div class="flex space-x-2 justify-center">
                <!-- <button *ngIf="order.status === 'قيد الإنتظار'" (click)="cancelOrder(order._id)" class="bg-red-500 dark:bg-red-600 text-white px-4 py-2 rounded hover:bg-red-600 dark:hover:bg-red-700">
                  إلغاء الطلب
                </button> -->
                <button *ngIf="order.status === 'قيد الإنتظار' || order.status === 'تم الشحن'" (click)="resumePayment(order)" class="bg-green-600 dark:bg-green-700 text-white px-4 py-2 rounded hover:bg-green-700 dark:hover:bg-green-800 ml-2">
                  استكمال الدفع
                </button>
              </div>
            </td>
          </tr>
        </ng-container>
      </ng-container>
      </ng-container>
    </tbody>
  </table>
</div>

<!-- بطاقات للشاشات الصغيرة فقط -->
<div *ngIf="orders.length > 0" class="block md:hidden px-4 space-y-4">
  <div *ngFor="let order of orders; let i = index"
       [ngClass]="i % 2 === 0 ? 'bg-blue-50 dark:bg-[#0a1325]' : 'bg-white dark:bg-gray-900'"
       class="p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-lg">
    
    <!-- الحالة -->
    <div class="flex justify-between items-center mb-2">
      <div class="text-sm font-semibold text-gray-600 dark:text-gray-300">الحالة:</div>
      <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold" [ngClass]="{
        'bg-orange-500 text-white dark:bg-orange-600': order.status === 'قيد الإنتظار',
        'bg-yellow-800 text-yellow-200 dark:bg-yellow-700 dark:text-yellow-300': order.status === 'تم الشحن',
        'bg-green-500 text-green-200 dark:bg-green-600 dark:text-green-300': order.status === 'تم التسليم',
        'bg-red-500 text-red-200 dark:bg-red-600 dark:text-red-300': order.status === 'تم الإلغاء'
      }">{{ order.status }}</span>
    </div>

    <!-- تاريخ الوصول -->
    <div class="flex justify-between items-center mb-2 text-sm">
      <div class="font-semibold text-gray-600 dark:text-gray-300">تاريخ الوصول المتوقع:</div>
      <div>{{ calculateExpectedDeliveryDate(order.orderDate) }}</div>
    </div>

    <!-- الكتب -->
    <div class="mb-2">
      <div class="font-semibold text-gray-600 dark:text-gray-300 text-sm mb-1">الكتب المطلوبة:</div>
      <div *ngFor="let product of order.products" class="mb-2">
        <div class="flex items-center justify-between">
          <div>
            {{ product.book }} <span class="text-xs text-gray-500 dark:text-gray-400">(كمية: {{ product.quantity }})</span>
          </div>
          <div *ngIf="order.status === 'تم التسليم'" class="flex items-center">
            <label for="rating-{{order._id}}-{{product.bookId}}" class="text-xs mr-1 dark:text-gray-300">تقييم:</label>
            <select id="rating-{{order._id}}-{{product.bookId}}" [(ngModel)]="product.selectedRating" class="dark:bg-gray-700 dark:text-gray-200">
              <option value="0" disabled>اختر التقييم</option>
              <option [value]="1">لم يعجبني</option>
              <option [value]="2">لم يعجبني قليلاً</option>
              <option [value]="3">متوسط</option>
              <option [value]="4">أعجبني قليلاً</option>
              <option [value]="5">أعجبني بشدة</option>
            </select>
            <button (click)="submitRating(product.bookId || '', product.selectedRating ?? 0)" [disabled]="!product.selectedRating || product.selectedRating < 1 || product.selectedRating > 5" class="ml-2 bg-blue-500 dark:bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 dark:hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
              إرسال التقييم
            </button>
          </div>
        </div>
      </div>
    </div>
      <!-- السعر الاجنالي -->
      <div class="flex justify-between items-center mb-2 text-sm">
        <div class="font-semibold text-gray-600 dark:text-gray-300"> السعر الإجمالي :</div>
        <div class="rtl">{{ order.totalAmount + ' ج.م' }}</div>
      </div>
    <!-- زر الإلغاء -->
    <div *ngIf="order.status === 'قيد الإنتظار'" class="mt-3 text-center space-x-2">
      <button (click)="cancelOrder(order._id)" class="bg-red-500 dark:bg-red-600 text-white px-4 py-2 rounded hover:bg-red-600 dark:hover:bg-red-700 transition">
        إلغاء الطلب
      </button>
      <button *ngIf="order.status === 'قيد الإنتظار' || order.status === 'تم الشحن'" (click)="resumePayment(order)" class="bg-green-600 dark:bg-green-700 text-white px-4 py-2 rounded hover:bg-green-700 dark:hover:bg-green-800 transition">
        استكمال الدفع
      </button>
    </div>
  </div>
</div>

<!-- لا توجد طلبات -->
<div *ngIf="orders.length === 0 && !loading && !error" class="text-center text-gray-500 dark:text-gray-400">
  لا توجد طلبات حالياً.
</div>

<!-- Pagination controls -->
<div class="flex justify-center mt-4 space-x-4">
  <button (click)="prevPage()" [disabled]="currentPage === 1" class="px-3 py-1 bg-gray-300 dark:bg-gray-700 rounded disabled:opacity-50">السابق</button>
  <span class="dark:text-gray-200">صفحة {{ currentPage }}</span>
  <button (click)="nextPage()" [disabled]="orders.length < pageSize" class="px-3 py-1 bg-gray-300 dark:bg-gray-700 rounded disabled:opacity-50">التالي</button>
</div>